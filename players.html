<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StompDonkey Disc Golf Association - Players</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <button class="hamburger" aria-label="Toggle Menu">☰</button>
        <h1>StompDonkey Disc Golf Association</h1>
    </header>
    <nav class="sidebar" style="display: none;">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="rounds.html">Rounds</a></li>
            <li><a href="records.html">Records</a></li>
            <li><a href="players.html">Players</a></li>
        </ul>
    </nav>
    <main>
        <section class="records-section">
            <h2>Player Profiles</h2>
            <div id="player-profiles" class="records-container"></div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        function parseCustomDate(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const hours = timePart.slice(0, 2);
            const minutes = timePart.slice(2, 4);
            const isoDate = `${datePart}T${hours}:${minutes}`;
            return new Date(isoDate);
        }

        fetch('data.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        const players = ['ArmyGeddon', 'Jobby', 'Bucis', 'Miza'];
                        const filteredData = data.filter(row => players.includes(row.PlayerName));

                        // Group data by player and sort by date descending
                        const playerData = {};
                        players.forEach(player => {
                            playerData[player] = filteredData
                                .filter(row => row.PlayerName === player)
                                .sort((a, b) => parseCustomDate(b.StartDate) - parseCustomDate(a.StartDate));
                        });

                        // Function to calculate current rating (best 8 of last 20)
                        function calculateCurrentRating(rounds) {
                            const last20 = rounds.slice(0, 20); // Last 20 rounds
                            const validRatings = last20
                                .map(r => parseInt(r.RoundRating) || 0)
                                .filter(r => r > 0)
                                .sort((a, b) => b - a) // Highest to lowest
                                .slice(0, 8); // Best 8
                            return validRatings.length ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(1) : 'N/A';
                        }

                        // Function to calculate previous rating (before most recent round)
                        function calculatePreviousRating(rounds) {
                            const last20 = rounds.slice(0, 20);
                            const validRatings = last20
                                .map(r => parseInt(r.RoundRating) || 0)
                                .filter(r => r > 0)
                                .sort((a, b) => b - a)
                                .slice(1, 9); // Exclude most recent, take next 8
                            return validRatings.length ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(1) : 'N/A';
                        }

                        // Function to determine rating movement
                        function getRatingMovement(current, previous) {
                            if (current === 'N/A' || previous === 'N/A') return '';
                            const diff = current - previous;
                            return diff > 0 ? `(+${diff})` : diff < 0 ? `(${diff})` : '(±0)';
                        }

                        // Generate player profiles
                        const container = document.getElementById('player-profiles');
                        players.forEach((player, index) => {
                            const rounds = playerData[player];
                            if (rounds.length === 0) return;

                            const totalRounds = rounds.length;
                            const totalScores = rounds.map(r => parseInt(r.Total) || 0).filter(s => s > 0);
                            const avgScore = totalScores.length ? (totalScores.reduce((a, b) => a + b, 0) / totalScores.length).toFixed(1) : 'N/A';
                            const bestScore = totalScores.length ? Math.min(...totalScores) : 'N/A';
                            const totalPlusMinus = rounds.map(r => parseInt(r['+/-']) || 0).reduce((a, b) => a + b, 0);
                            const currentRating = calculateCurrentRating(rounds);
                            const previousRating = calculatePreviousRating(rounds);
                            const ratingMovement = getRatingMovement(parseFloat(currentRating) || 0, parseFloat(previousRating) || 0);

                            const card = document.createElement('div');
                            card.className = 'record-card player-profile';
                            card.style.animationDelay = `${index * 0.1}s`;

                            card.innerHTML = `
                                <h3>${player}</h3>
                                <p><strong>Rounds Played:</strong> ${totalRounds}</p>
                                <p><strong>Average Score:</strong> ${avgScore}</p>
                                <p><strong>Best Score:</strong> ${bestScore} (${rounds.find(r => parseInt(r.Total) === bestScore)?.StartDate.split(' ')[0] || 'N/A'})</p>
                                <p><strong>Total +/-:</strong> ${totalPlusMinus}</p>
                                <p><strong>Current Rating:</strong> ${currentRating} ${ratingMovement}</p>
                                <p><strong>Bio:</strong> [Add a fun bio or story here!]</p>
                                <p><strong>Avatar:</strong> [Upload an image to personalize!]</p>
                            `;
                            container.appendChild(card);
                        });
                    }
                });
            })
            .catch(error => console.error('Error fetching CSV:', error));

        document.querySelector('.hamburger').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        });
    </script>
</body>
</html>
