<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StompDonkey Disc Golf Association - Players</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script> <!-- Zoom plugin -->
</head>
<body>
    <header class="main-header">
        <button class="hamburger" aria-label="Toggle Menu">☰</button>
        <h1>StompDonkey Disc Golf Association</h1>
    </header>
    <nav class="sidebar" style="display: none;">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="rounds.html">Rounds</a></li>
            <li><a href="records.html">Records</a></li>
            <li><a href="players.html">Players</a></li>
        </ul>
    </nav>
    <main>
        <section class="records-section">
            <h2>Player Profiles</h2>
            <div id="player-profiles" class="records-container"></div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        function parseCustomDate(dateStr) {
            const [datePart] = dateStr.split(' ');
            return new Date(datePart);
        }

        function isRoundComplete(row) {
            for (let i = 1; i <= 18; i++) {
                const holeScore = parseInt(row[`Hole${i}`]) || 0;
                if (holeScore === 0 || isNaN(holeScore)) return false;
            }
            return true;
        }

        fetch('data.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        const players = ['ArmyGeddon', 'Jobby', 'Bucis', 'Miza'];
                        const filteredData = data.filter(row => players.includes(row.PlayerName) && isRoundComplete(row));

                        const playerData = {};
                        players.forEach(player => {
                            playerData[player] = filteredData
                                .filter(row => row.PlayerName === player)
                                .sort((a, b) => parseCustomDate(b.StartDate) - parseCustomDate(a.StartDate));
                        });

                        function calculateCurrentRating(rounds) {
                            const last20 = rounds.slice(0, 20);
                            const validRatings = last20
                                .map(r => parseInt(r.RoundRating) || 0)
                                .filter(r => r > 0)
                                .sort((a, b) => b - a)
                                .slice(0, 8);
                            return validRatings.length ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(2) : 'N/A';
                        }

                        function calculatePreviousRating(rounds) {
                            const last20 = rounds.slice(0, 20);
                            const validRatings = last20
                                .map(r => parseInt(r.RoundRating) || 0)
                                .filter(r => r > 0)
                                .sort((a, b) => b - a)
                                .slice(1, 9);
                            return validRatings.length ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(2) : 'N/A';
                        }

                        function getRatingMovement(current, previous) {
                            if (current === 'N/A' || previous === 'N/A') return '';
                            const diff = parseFloat(current) - parseFloat(previous);
                            return diff > 0 ? `(+${diff.toFixed(2)})` : diff < 0 ? `(${diff.toFixed(2)})` : '(±0.00)';
                        }

                        function countAces(rounds) {
                            let aceCount = 0;
                            rounds.forEach(round => {
                                for (let i = 1; i <= 18; i++) {
                                    if (parseInt(round[`Hole${i}`]) === 1) aceCount++;
                                }
                            });
                            return aceCount;
                        }

                        function getBestScoresPerCourse(rounds) {
                            const bestScores = {};
                            rounds.forEach(round => {
                                const course = round.CourseName;
                                const total = parseInt(round.Total);
                                const plusMinus = parseInt(round['+/-']);
                                const date = round.StartDate.split(' ')[0];
                                if (!bestScores[course] || total < parseInt(bestScores[course].total)) {
                                    bestScores[course] = { total, plusMinus, date };
                                }
                            });
                            return bestScores;
                        }

                        function getJourneyOverview(rounds) {
                            if (rounds.length === 0) return '';
                            const firstRound = rounds[rounds.length - 1];
                            const firstMonthYear = new Date(parseCustomDate(firstRound.StartDate)).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                            const validRatings = rounds
                                .map(r => ({ rating: parseInt(r.RoundRating) || 0, ...r }))
                                .filter(r => r.rating > 0)
                                .sort((a, b) => parseCustomDate(a.StartDate) - parseCustomDate(b.StartDate));
                            const earlyLow = validRatings.length ? validRatings[0] : null;
                            const peak = validRatings.reduce((max, current) => max.rating > current.rating ? max : current, validRatings[0]);
                            return `
                                <p>Journey Overview: ArmyGeddon first appeared on the disc golf scene in ${firstMonthYear} and since demonstrates a clear trajectory of improvement in his disc golf performance. His RoundRating has increased over time, reflecting enhanced skill and consistency. From an early low round rating of ${earlyLow ? earlyLow.rating : 'N/A'} at ${earlyLow ? earlyLow.CourseName : 'N/A'} in ${earlyLow ? new Date(parseCustomDate(earlyLow.StartDate)).toLocaleString('en-US', { month: 'long', year: 'numeric' }) : 'N/A'} to a peak round rating of ${peak.rating} when he shot ${peak['+/-'] > 0 ? '+' + peak['+/-'] : peak['+/-']} at ${peak.CourseName} in ${new Date(parseCustomDate(peak.StartDate)).toLocaleString('en-US', { month: 'long', year: 'numeric' })}, his progress is notable.</p>
                            `;
                        }

                        const container = document.getElementById('player-profiles');
                        players.forEach((player, index) => {
                            const rounds = playerData[player];
                            if (rounds.length === 0) return;

                            const totalRounds = rounds.length;
                            const totalScores = rounds.map(r => parseInt(r.Total) || 0).filter(s => s > 0);
                            const avgScore = totalScores.length ? (totalScores.reduce((a, b) => a + b, 0) / totalScores.length).toFixed(1) : 'N/A';
                            const totalPlusMinus = rounds.map(r => parseInt(r['+/-']) || 0).reduce((a, b) => a + b, 0);
                            const currentRating = calculateCurrentRating(rounds);
                            const previousRating = calculatePreviousRating(rounds);
                            const ratingMovement = getRatingMovement(parseFloat(currentRating) || 0, parseFloat(previousRating) || 0);
                            const aceCount = countAces(rounds);
                            const bestScores = getBestScoresPerCourse(rounds);

                            const card = document.createElement('div');
                            card.className = 'record-card player-profile';
                            card.style.animationDelay = `${index * 0.1}s`;

                            const bestScoresHtml = Object.entries(bestScores).map(([course, data]) => `
                                <li><strong>${course}</strong>: ${data.total} (+${data.plusMinus}) on ${data.date}</li>
                            `).join('');

                            let journeyOverview = '';
                            if (player === 'ArmyGeddon') {
                                journeyOverview = getJourneyOverview(rounds);
                            }

                            // Prepare data for chart
                            const roundDates = rounds.map(r => r.StartDate.split(' ')[0]);
                            const roundRatings = rounds.map(r => parseInt(r.RoundRating) || null);
                            const movingAvgRatings = [];
                            for (let i = 0; i < rounds.length; i++) {
                                const window = rounds.slice(Math.max(0, i - 7), i + 1); // 8-round moving average
                                const validRatings = window.map(r => parseInt(r.RoundRating) || 0).filter(r => r > 0);
                                movingAvgRatings.push(validRatings.length ? (validRatings.reduce((a, b) => a + b, 0) / validRatings.length).toFixed(2) : null);
                            }

                            card.innerHTML = `
                                <h3>${player}</h3>
                                <p><strong>Rounds Played:</strong> ${totalRounds}</p>
                                <p><strong>Average Score:</strong> ${avgScore}</p>
                                <p><strong>Best Scores by Course:</strong></p>
                                <ul>${bestScoresHtml}</ul>
                                <p><strong>Total +/-:</strong> ${totalPlusMinus}</p>
                                <p><strong>Current Rating:</strong> ${currentRating} ${ratingMovement}</p>
                                <p><strong>Ace Count:</strong> ${aceCount}</p>
                                ${journeyOverview}
                                <div class="chart-container">
                                    <canvas id="chart-${player.toLowerCase()}" class="player-chart"></canvas>
                                </div>
                            `;

                            container.appendChild(card);

                            // Initialize chart after card is added to DOM
                            const ctx = document.getElementById(`chart-${player.toLowerCase()}`).getContext('2d');
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: roundDates,
                                    datasets: [
                                        {
                                            label: 'Round Rating',
                                            data: roundRatings,
                                            borderColor: 'rgba(54, 162, 235, 1)', // Blue like UDisc
                                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                            fill: false,
                                            tension: 0.1,
                                            pointRadius: 5,
                                            pointHoverRadius: 7
                                        },
                                        {
                                            label: 'Moving Average Rating (8 rounds)',
                                            data: movingAvgRatings,
                                            borderColor: 'rgba(255, 159, 64, 1)', // Orange like UDisc
                                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                            fill: false,
                                            borderWidth: 2,
                                            tension: 0.1,
                                            pointRadius: 0 // No points for moving average
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            title: { display: true, text: 'Date', color: '#fff', font: { family: 'Oswald', size: 14 } },
                                            ticks: { color: '#fff' }
                                        },
                                        y: {
                                            title: { display: true, text: 'Rating', color: '#fff', font: { family: 'Oswald', size: 14 } },
                                            beginAtZero: false,
                                            min: 90,
                                            max: 210,
                                            ticks: { color: '#fff' }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                            labels: { color: '#fff', font: { family: 'Oswald', size: 12 } }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            callbacks: {
                                                label: function(context) {
                                                    const round = rounds[context.dataIndex];
                                                    return [
                                                        `${context.dataset.label}: ${context.raw}`,
                                                        `Score: ${round.Total}`,
                                                        `+/-: ${round['+/-'] >= 0 ? '+' + round['+/-'] : round['+/-']}`,
                                                        `Course: ${round.CourseName}`,
                                                        `Date: ${round.StartDate.split(' ')[0]}`
                                                    ];
                                                }
                                            },
                                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                            titleColor: '#fff',
                                            bodyColor: '#fff',
                                            borderColor: 'rgba(255, 255, 255, 0.2)',
                                            borderWidth: 1
                                        },
                                        zoom: {
                                            zoom: {
                                                wheel: { enabled: true },
                                                pinch: { enabled: true },
                                                mode: 'xy'
                                            },
                                            pan: {
                                                enabled: true,
                                                mode: 'xy'
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    }
                });
            })
            .catch(error => console.error('Error fetching CSV:', error));

        document.querySelector('.hamburger').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        });
    </script>
</body>
</html>
​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​