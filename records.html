<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StompDonkey Disc Golf Association - Records</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <button class="hamburger" aria-label="Toggle Menu">â˜°</button>
        <h1>StompDonkey Disc Golf Association</h1>
    </header>
    <nav class="sidebar" style="display: none;">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="rounds.html">Rounds</a></li>
            <li><a href="records.html">Records</a></li>
            <li><a href="players.html">Players</a></li>
        </ul>
    </nav>
    <main>
        <section class="records-section">
            <h2>Course Records</h2>
            <div id="course-records" class="records-container"></div>
        </section>
        <section class="records-section">
            <h2>Personal Bests</h2>
            <div id="personal-bests" class="records-container"></div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        function parseCustomDate(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const hours = timePart.slice(0, 2);
            const minutes = timePart.slice(2, 4);
            const isoDate = `${datePart}T${hours}:${minutes}`;
            return new Date(isoDate);
        }

        fetch('data.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        const players = ['ArmyGeddon', 'Jobby', 'Bucis', 'Miza'];
                        const filteredData = data.filter(row => players.includes(row.PlayerName));
                        
                        const courseRecords = {};
                        filteredData.forEach(row => {
                            const key = `${row.CourseName}-${row.LayoutName}`;
                            const total = parseInt(row.Total);
                            const date = parseCustomDate(row.StartDate);
                            if (!courseRecords[key]) {
                                courseRecords[key] = { minTotal: total, records: [{ player: row.PlayerName, date }] };
                            } else {
                                if (total < courseRecords[key].minTotal) {
                                    courseRecords[key].minTotal = total;
                                    courseRecords[key].records = [{ player: row.PlayerName, date }];
                                } else if (total === courseRecords[key].minTotal) {
                                    courseRecords[key].records.push({ player: row.PlayerName, date });
                                }
                            }
                        });
                        
                        const courseRecordsHtml = Object.entries(courseRecords).map(([key, record]) => {
                            const [course, layout] = key.split('-');
                            const holders = record.records.map(r => `${r.player} on ${r.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`).join(', ');
                            return `
                                <div class="record-card course-record">
                                    <h3>${course} - ${layout}</h3>
                                    <p><strong>Score:</strong> ${record.minTotal}</p>
                                    <p><strong>Held by:</strong> ${holders}</p>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('course-records').innerHTML = courseRecordsHtml;
                        
                        const personalBests = {};
                        filteredData.forEach(row => {
                            const key = `${row.PlayerName}-${row.CourseName}-${row.LayoutName}`;
                            const total = parseInt(row.Total);
                            const date = parseCustomDate(row.StartDate);
                            if (!personalBests[key]) {
                                personalBests[key] = { minTotal: total, date };
                            } else {
                                if (total < personalBests[key].minTotal) {
                                    personalBests[key].minTotal = total;
                                    personalBests[key].date = date;
                                } else if (total === personalBests[key].minTotal && date > personalBests[key].date) {
                                    personalBests[key].date = date;
                                }
                            }
                        });
                        
                        const playerBests = {};
                        for (const key in personalBests) {
                            const [player, course, layout] = key.split('-');
                            if (!playerBests[player]) {
                                playerBests[player] = [];
                            }
                            playerBests[player].push({ course, layout, minTotal: personalBests[key].minTotal, date: personalBests[key].date });
                        }
                        
                        const personalBestsHtml = Object.entries(playerBests).map(([player, bests]) => {
                            const bestsList = bests.map(b => `
                                <li>
                                    <strong>${b.course} - ${b.layout}</strong>: ${b.minTotal} on ${b.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                </li>
                            `).join('');
                            return `
                                <div class="record-card personal-best ${player.toLowerCase()}">
                                    <h3>${player}</h3>
                                    <ul>${bestsList}</ul>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('personal-bests').innerHTML = personalBestsHtml;
                    }
                });
            })
            .catch(error => console.error('Error fetching CSV:', error));

        document.querySelector('.hamburger').addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        });
    </script>
</body>
</html>
